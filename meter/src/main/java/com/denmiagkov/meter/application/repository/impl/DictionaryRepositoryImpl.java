package com.denmiagkov.meter.application.repository.impl;

import com.denmiagkov.meter.application.repository.DictionaryRepository;
import com.denmiagkov.meter.utils.ConnectionManager;
import org.springframework.stereotype.Repository;

import java.sql.*;
import java.util.HashMap;
import java.util.Map;
/**
 * Класс реализует логику взаимодействия с базой данных по поводу справочника услуг (типов показаний)
 * */
@Repository
public class DictionaryRepositoryImpl implements DictionaryRepository {
    /**
     * SQL-запрос на добавление в справочник нового типа услуг
     * */
    public static final String ADD_PUBLIC_UTILITY_TYPE_TO_DICTIONARY = """
            INSERT INTO meter_service.utilities_dictionary (utility_type)
            VALUES (?);
            """;
    /**
     * SQL-запрос на выборку всех типов услуг из справочника
     * */
    private static final String GET_ALL_PUBLIC_UTILITIES_TYPES = """
            SELECT id, utility_type
            FROM meter_service.utilities_dictionary;
            """;

    /**
     * {@inheritDoc}
     * */
    @Override
    public int addUtilityTypeToDictionary(String utilityName) {
        try (Connection connection = ConnectionManager.open();
             PreparedStatement statement = connection.prepareStatement(
                     ADD_PUBLIC_UTILITY_TYPE_TO_DICTIONARY,
                     Statement.RETURN_GENERATED_KEYS)) {
            statement.setString(1, utilityName);
            statement.executeUpdate();
            ResultSet generatedKey = statement.getGeneratedKeys();
            int newUtilityId = -1;
            if (generatedKey.next()) {
                newUtilityId = generatedKey.getInt("id");
            }
            return newUtilityId;
        } catch (SQLException e) {
            throw new RuntimeException(e);
        }
    }

    /**
     * {@inheritDoc}
     * */
    @Override
    public Map<Integer, String> getAllUtilitiesTypes() {
        Map<Integer, String> allPublicUtilitiesTypes = new HashMap<>();
        try (Connection connection = ConnectionManager.open();
             PreparedStatement statement = connection.prepareStatement(GET_ALL_PUBLIC_UTILITIES_TYPES)) {
            ResultSet queryResult = statement.executeQuery();
            while (queryResult.next()) {
                allPublicUtilitiesTypes.put(
                        queryResult.getInt("id"),
                        queryResult.getString("utility_type")
                );
            }
        } catch (SQLException e) {
            throw new RuntimeException(e);
        }
        return allPublicUtilitiesTypes;
    }
}
